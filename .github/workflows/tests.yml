name: Run pytest
on: [pull_request]

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.7.5'
      
      - name: Set up cache
        uses: actions/cache@v2
        with:
          path: venv
          key: venv-${{ runner.os }}-${{ hashFiles('requirements*') }}

      - name: Apt
        run: sudo apt-get -q update && sudo apt-get -y install libdbus-1-3 libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0
      
      - name: pip
        run: |
          python3 -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade -r requirements-setuptools.txt
          python -m pip install -r requirements.txt
          python -m pip install -r requirements-xvfb.txt
          python -m pip install codecov
          python -m pip install -e . -e ".[gui]" -e ".[server]" -e ".[test]"
          python -m pip uninstall -y randovania
      
      - name: build wheel
        run: |          
          source venv/bin/activate
          python setup.py bdist_wheel
          python -m pip install --upgrade dist/*.whl
      
      - name: run pytest
        run: source venv/bin/activate && python -m pytest --cov randovania
      
      - name: codecov
        run: source venv/bin/activate && codecov

  windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.7.5'
      
      - name: Set up cache
        uses: actions/cache@v2
        with:
          path: venv
          key: venv-${{ runner.os }}-${{ hashFiles('requirements*') }}
      
      - name: pip
        run: |
          python -m venv venv
          venv/Scripts/activate.ps1
          python -m pip install --upgrade -r requirements-setuptools.txt
          python -m pip install -r requirements.txt
          python -m pip install -e . -e ".[gui]" -e ".[test]"
          python setup.py build_ui
      
      - name: create executable
        run: |
          venv/Scripts/activate.ps1
          python tools/create_release.py

      - name: executable check
        run: dist/randovania/randovania.exe --version

      - name: executable test
        run: dist/randovania/randovania.exe --pytest --skip-gui-tests --skip-echo-tool
